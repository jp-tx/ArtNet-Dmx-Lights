@page
@{
    ViewData["Title"] = "Groups";
}

<section>
    <h1 class="page-title">Fixture Groups</h1>
    <p class="page-subtitle">Define channel ranges and map them to universes.</p>

    <div class="grid two">
        <div class="panel">
            <div class="panel-header">
                <h3 class="panel-title">Create Group</h3>
                <span class="tag">1-512</span>
            </div>
            <div class="field">
                <label for="groupName">Group name</label>
                <input id="groupName" type="text" placeholder="Front Wash" />
            </div>
            <div class="row">
                <div class="field">
                    <label for="groupUniverse">Universe</label>
                    <input id="groupUniverse" type="number" min="0" max="2" />
                </div>
                <div class="field">
                    <label for="groupStart">Start channel</label>
                    <input id="groupStart" type="number" min="1" max="512" />
                </div>
                <div class="field">
                    <label for="groupCount">Channel count</label>
                    <input id="groupCount" type="number" min="1" max="512" />
                </div>
            </div>
            <button class="btn" id="createGroup">Add group</button>
            <div class="notice" id="groupNotice" style="margin-top:16px; display:none;"></div>
        </div>

        <div class="panel">
            <div class="panel-header">
                <h3 class="panel-title">Existing Groups</h3>
                <span class="tag" id="groupCountLabel">0 groups</span>
            </div>
            <div id="groupList" class="list"></div>
        </div>
    </div>
</section>

@section Scripts {
<script>
  const groupNotice = document.getElementById("groupNotice");
  const groupList = document.getElementById("groupList");
  const groupCountLabel = document.getElementById("groupCountLabel");
  const fields = {
    name: document.getElementById("groupName"),
    universe: document.getElementById("groupUniverse"),
    start: document.getElementById("groupStart"),
    count: document.getElementById("groupCount")
  };

  const showNotice = (text) => {
    groupNotice.textContent = text;
    groupNotice.style.display = "block";
    setTimeout(() => groupNotice.style.display = "none", 4000);
  };

  async function loadGroups() {
    const groups = await app.api("/api/v1/groups");
    groupList.innerHTML = "";
    groupCountLabel.textContent = `${groups.length} groups`;
    if (!groups.length) {
      groupList.innerHTML = "<div class='list-item'>No groups yet.</div>";
      return;
    }

    groups.forEach((group) => {
      const item = document.createElement("div");
      item.className = "list-item";
      item.innerHTML = `
        <header>
          <h4>${group.name}</h4>
          <div class="mono">Universe ${group.universe}</div>
        </header>
        <div class="row">
          <div class="field">
            <label>Name</label>
            <input type="text" value="${group.name}" />
          </div>
          <div class="field">
            <label>Universe</label>
            <input type="number" min="0" max="2" value="${group.universe}" />
          </div>
          <div class="field">
            <label>Start</label>
            <input type="number" min="1" max="512" value="${group.startChannel}" />
          </div>
          <div class="field">
            <label>Count</label>
            <input type="number" min="1" max="512" value="${group.channelCount}" />
          </div>
        </div>
        <div class="row">
          <button class="btn secondary" data-action="save">Save</button>
          <button class="btn danger" data-action="delete">Delete</button>
        </div>
      `;

      const inputs = item.querySelectorAll("input");
      item.querySelector("[data-action='save']").addEventListener("click", async () => {
        const payload = {
          name: inputs[0].value.trim(),
          universe: Number(inputs[1].value),
          startChannel: Number(inputs[2].value),
          channelCount: Number(inputs[3].value)
        };
        try {
          await app.api(`/api/v1/groups/${group.id}`, {
            method: "PUT",
            body: JSON.stringify(payload)
          });
          showNotice("Group updated.");
          await loadGroups();
        } catch (error) {
          showNotice(error.message);
        }
      });

      item.querySelector("[data-action='delete']").addEventListener("click", async () => {
        try {
          await app.api(`/api/v1/groups/${group.id}`, { method: "DELETE" });
          showNotice("Group deleted.");
          await loadGroups();
        } catch (error) {
          showNotice(error.message);
        }
      });

      groupList.appendChild(item);
    });
  }

  document.getElementById("createGroup").addEventListener("click", async () => {
    const payload = {
      name: fields.name.value.trim(),
      universe: Number(fields.universe.value),
      startChannel: Number(fields.start.value),
      channelCount: Number(fields.count.value)
    };
    try {
      await app.api("/api/v1/groups", { method: "POST", body: JSON.stringify(payload) });
      fields.name.value = "";
      fields.start.value = "";
      fields.count.value = "";
      showNotice("Group created.");
      await loadGroups();
    } catch (error) {
      showNotice(error.message);
    }
  });

  loadGroups().catch(error => showNotice(error.message));
</script>
}
