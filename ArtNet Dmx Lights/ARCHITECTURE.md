# Architecture Overview

## Summary
The app is a Razor Pages frontend backed by a minimal HTTP API. All UI actions
call the `/api/v1` endpoints. State is persisted as JSON files in the container
filesystem under a `data/` directory. ArtNet output is generated by a DMX
engine that applies presets, handles fades, and sends ArtDMX packets over UDP.

## Core Components
- **API Endpoints**: Minimal API route handlers in `Api/` implement CRUD and
  activation for settings, groups, presets, schedules, logs, backup, and status.
- **AppStateStore**: `Services/AppStateStore.cs` caches settings, groups,
  presets, schedules, logs, and runtime state in memory and persists each
  change to JSON files (atomic write).
- **ValidationService**: Centralized validation for settings, groups, presets,
  and schedules (channel ranges, universe ranges, value ranges).
- **DmxEngine**: Applies presets with overlap resolution, linear fades, and
  updates runtime/log state. Uses a `DmxStateCache` to preserve channel values
  for channels omitted from a preset.
- **ArtNetSender**: Builds ArtDMX packets and sends them via UDP with explicit
  Net/SubNet and per-group Universe mapping.
- **SchedulerService**: Runs every 30 seconds, evaluates daily schedules in
  local time, resolves sunrise/sunset offsets, and triggers presets.
- **GeoTimeLookupService**: Resolves ZIP -> lat/lon and lat/lon -> time zone.
- **SunriseSunsetService**: Fetches sunrise/sunset times by coordinates.
- **LogRetentionService**: Trims logs beyond 72 hours.
- **StartupService**: On boot, applies the last scheduled preset or zeros all
  fixture group channels if no scheduled preset exists.

## Data Storage Layout
All data lives under `data/` in the app content root:
- `data/settings.json`
- `data/groups.json`
- `data/presets.json`
- `data/schedules.json`
- `data/logs.json`
- `data/runtime.json`

Backup export/import bundles settings, groups, presets, and schedules only.
Logs are preserved across import.

## Request Flow (Example: Preset Activation)
1) UI calls `POST /api/v1/presets/{presetId}/activate`.
2) `PresetEndpoints` delegates to `DmxEngine`.
3) `DmxEngine`:
   - Builds target DMX values with "highest value wins" overlap rule.
   - Preserves untouched channels from the current cache.
   - Applies a linear fade over `fadeMs`.
   - Sends per-universe ArtDMX frames via `ArtNetSender`.
   - Updates runtime state and logs a single DMX change event.

## Scheduling Flow
1) Scheduler runs every 30 seconds.
2) Evaluates fixed times in the resolved local time zone.
3) For sunrise/sunset, fetches daily times (cached in settings for offline use).
4) If multiple schedules trigger in the same minute, the last updated wins.
5) Activates the preset using `DmxEngine`.

## Frontend
Razor Pages serve static HTML and JS. Each page uses `window.app.api` to call
the backend. No server-side rendering of data is used; all state is fetched via
the API.

## Testing
Unit and integration tests live in `ArtNetDmxLights.Tests` and cover:
- Model serialization
- Validation rules
- API endpoints
- Scheduler evaluation
- ArtNet packet creation
- Startup behavior
- Integration flows for settings, presets, schedules, backup, and logs
